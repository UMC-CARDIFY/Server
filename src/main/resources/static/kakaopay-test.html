<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카카오페이 정기결제 테스트</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 포트원 라이브러리 추가 -->
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <style>
      body {
          font-family: 'Noto Sans KR', sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
      }
      .card {
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      h1, h2 {
          color: #333;
      }
      button {
          background-color: #ffeb3b;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
          margin-top: 10px;
      }
      button:hover {
          background-color: #ffd600;
      }
      pre {
          background-color: #f5f5f5;
          padding: 10px;
          border-radius: 4px;
          overflow-x: auto;
      }
      .input-group {
          margin-bottom: 15px;
      }
      label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
      }
      input, select {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
  </style>
</head>
<body>
<h1>카카오페이 정기결제 테스트</h1>

<div class="card">
  <h2>1. 빌링키 발급 요청</h2>
  <div class="input-group">
    <label for="userId">사용자 ID</label>
    <input type="number" id="userId" value="1">
  </div>
  <div class="input-group">
    <label for="productId">상품 ID</label>
    <input type="number" id="productId" value="1">
  </div>
  <div class="input-group">
    <label for="email">이메일</label>
    <input type="email" id="email" value="user@example.com">
  </div>
  <div class="input-group">
    <label for="name">이름</label>
    <input type="text" id="name" value="홍길동">
  </div>
  <div class="input-group">
    <label for="pgProvider">pg사</label>
    <input type="text" id="pgProvider" value="KAKAOPAY">
  </div>
  <div class="input-group">
    <label for="backendUrl">백엔드 URL</label>
    <input type="text" id="backendUrl" value="http://localhost:8080">
  </div>

  <button id="requestBillingKey">빌링키 발급 요청</button>
  <div id="requestResult" style="margin-top: 10px;"></div>
</div>

<div class="card">
  <h2>2. 빌링키 승인 요청</h2>
  <div class="input-group">
    <label for="pgToken">PG 토큰</label>
    <input type="text" id="pgToken" placeholder="결제창에서 받은 pg_token">
  </div>
  <div class="input-group">
    <label for="merchantUid">Merchant UID</label>
    <input type="text" id="merchantUid" placeholder="빌링키 요청 시 받은 merchantUid">
  </div>
  <div class="input-group">
    <label for="customerUid">Customer UID</label>
    <input type="text" id="customerUid" placeholder="빌링키 요청 시 받은 customerUid">
  </div>
  <div class="input-group">
    <label for="productId2">Product ID</label>
    <input type="text" id="productId2" placeholder="구독하고자 하는 상품 productId">
  </div>
  <div class="input-group">
    <label for="userId2">User ID</label>
    <input type="text" id="userId2" placeholder="사용자의 id">
  </div>

  <button id="approveBillingKey">빌링키 승인 요청</button>
  <div id="approveResult" style="margin-top: 10px;"></div>
</div>

<script>
    // 포트원 초기화
    window.IMP.init('imp03025662');

    // URL 파라미터 가져오기
    const getUrlParams = () => {
        const params = {};
        window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,
            function(str, key, value) { params[key] = decodeURIComponent(value); }
        );
        return params;
    };

    // 페이지 로드 시 URL 파라미터 확인
    $(document).ready(function() {
        const params = getUrlParams();

        // pg_token이 URL에 있으면 (결제 성공 후 리다이렉트)
        if (params.pg_token) {
            $('#pgToken').val(params.pg_token);
            if (params.merchant_uid) $('#merchantUid').val(params.merchant_uid);
            alert('결제 인증이 완료되었습니다. 빌링키 승인 요청을 진행하세요.');
        }
    });

    // 빌링키 발급 요청
    $('#requestBillingKey').click(function() {
        const userId = $('#userId').val();
        const productId = $('#productId').val();
        const email = $('#email').val();
        const name = $('#name').val();
        const backendUrl = $('#backendUrl').val();
        const pgProvider = $('#pgProvider').val();

        const requestData = {
            userId: Number(userId),
            productId: Number(productId),
            email: email,
            name: name,
            callbackUrl: window.location.origin,
            pgProvider: pgProvider
        };

        $('#requestResult').html('요청 중...');

        // 백엔드 API 호출
        $.ajax({
            url: `${backendUrl}/api/v1/payments/simple-pay/billing-key/request`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log('빌링키 발급 요청 성공:', response);
                $('#requestResult').html(
                    `<pre>${JSON.stringify(response, null, 2)}</pre>` +
                    `<p>merchantUid: ${response.merchantUid}</p>` +
                    `<p>customerUid: ${response.customerUid}</p>`
                );

                // 응답에서 받은 값 저장
                $('#merchantUid').val(response.merchantUid);
                $('#customerUid').val(response.customerUid);

                // 포트원 SDK로 결제창 호출
                IMP.request_pay(response.requestData, function(rsp) {
                    if (rsp.success) {
                        // 결제 성공 시
                        alert('결제 성공: ' + rsp.pg_token);
                        $('#pgToken').val(rsp.pg_token);
                    } else {
                        // 결제 실패 시
                        alert('결제 실패: ' + rsp.error_msg);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('빌링키 발급 요청 실패:', error);
                $('#requestResult').html(`<p style="color: red;">오류: ${error}</p>`);
                if (xhr.responseText) {
                    $('#requestResult').append(`<pre>${xhr.responseText}</pre>`);
                }
            }
        });
    });

    // 빌링키 승인 요청
    $('#approveBillingKey').click(function() {
        const pgToken = $('#pgToken').val();
        const merchantUid = $('#merchantUid').val();
        const customerUid = $('#customerUid').val();
        const userId = $('#userId').val();
        const backendUrl = $('#backendUrl').val();
        const productId = $('#productId').val();

        if (!pgToken || !merchantUid || !customerUid) {
            alert('PG 토큰, Merchant UID, Customer UID를 모두 입력해주세요.');
            return;
        }

        const requestData = {
            pgToken: pgToken,
            merchantUid: merchantUid,
            customerUid: customerUid,
            userId: Number(userId),
            productId: productId
        };

        $('#approveResult').html('요청 중...');

        // 백엔드 API 호출
        $.ajax({
            url: `${backendUrl}/api/v1/payments/simple-pay/billing-key/approve`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                console.log('빌링키 승인 요청 성공:', response);
                $('#approveResult').html(`<pre>${JSON.stringify(response, null, 2)}</pre>`);
                alert('빌링키가 성공적으로 발급되었습니다!');
            },
            error: function(xhr, status, error) {
                console.error('빌링키 승인 요청 실패:', error);
                $('#approveResult').html(`<p style="color: red;">오류: ${error}</p>`);
                if (xhr.responseText) {
                    $('#approveResult').append(`<pre>${xhr.responseText}</pre>`);
                }
            }
        });
    });
</script>
</body>
</html>