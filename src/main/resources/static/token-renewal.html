<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
      }
      .container {
          background-color: #f5f5f5;
          border-radius: 5px;
          padding: 15px;
          margin-bottom: 20px;
      }
      h2 {
          margin-top: 0;
          color: #333;
      }
      pre {
          background-color: #eee;
          padding: 10px;
          border-radius: 3px;
          overflow: auto;
          font-size: 12px;
      }
      button {
          background-color: #4CAF50;
          color: white;
          border: none;
          padding: 10px 15px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 4px 2px;
          cursor: pointer;
          border-radius: 4px;
      }
      .logout-btn {
          background-color: #f44336;
      }
      .result {
          margin-top: 10px;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
      .success {
          color: green;
      }
      .error {
          color: red;
      }
      .info {
          color: blue;
      }
      .token-history {
          background-color: #fff;
          border: 1px solid #ccc;
          padding: 10px;
          margin-top: 10px;
          border-radius: 4px;
      }
  </style>
</head>
<body>
<h1>ğŸ” í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

<div class="container">
  <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
  <ol>
    <li><strong>ì²« ë²ˆì§¸ ë¡œê·¸ì¸:</strong> OAuth ë¡œê·¸ì¸ â†’ í† í° ì €ì¥ â†’ "í† í° íˆìŠ¤í† ë¦¬ì— ì¶”ê°€" í´ë¦­</li>
    <li><strong>ë‘ ë²ˆì§¸ ë¡œê·¸ì¸:</strong> ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ ë‹¤ì‹œ OAuth ë¡œê·¸ì¸ â†’ í† í° ì €ì¥ â†’ "í† í° íˆìŠ¤í† ë¦¬ì— ì¶”ê°€" í´ë¦­</li>
    <li><strong>ê²°ê³¼ í™•ì¸:</strong> í† í° ê°’ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ íˆìŠ¤í† ë¦¬ì—ì„œ ë¹„êµ</li>
  </ol>
</div>

<div class="container">
  <h2>ğŸ¯ ë¹ ë¥¸ OAuth ë¡œê·¸ì¸</h2>
  <button onclick="location.href='/oauth2/authorization/kakao'">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
  <button onclick="location.href='/oauth2/authorization/google'">êµ¬ê¸€ ë¡œê·¸ì¸</button>
  <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="container">
  <h2>ğŸ”‘ í˜„ì¬ í† í° ìƒíƒœ</h2>
  <button id="check-current-token">í˜„ì¬ í† í° í™•ì¸</button>
  <button id="fetch-new-token">ìƒˆ í† í° ê°€ì ¸ì˜¤ê¸°</button>
  <button id="add-to-history">í† í° íˆìŠ¤í† ë¦¬ì— ì¶”ê°€</button>
  <div id="current-token-result" class="result">í˜„ì¬ í† í° ìƒíƒœê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<div class="container">
  <h2>ğŸ“ˆ í† í° íˆìŠ¤í† ë¦¬ (ê°±ì‹  í™•ì¸ìš©)</h2>
  <button onclick="clearHistory()">íˆìŠ¤í† ë¦¬ ì‚­ì œ</button>
  <div id="token-history" class="token-history">
    í† í° ë³€ê²½ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
  </div>
</div>

<div class="container">
  <h2>ğŸ§ª API í…ŒìŠ¤íŠ¸</h2>
  <button id="test-api">ì‚¬ìš©ì ì •ë³´ API í˜¸ì¶œ</button>
  <div id="api-result" class="result">API ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    let tokenHistory = JSON.parse(localStorage.getItem('tokenHistory') || '[]');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
        checkCurrentToken();
        displayTokenHistory();

        // URL íŒŒë¼ë¯¸í„° ì²´í¬ (OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ í›„)
        const urlParams = new URLSearchParams(window.location.search);
        if (window.location.pathname.includes('auth') || document.referrer.includes('oauth')) {
            document.getElementById('current-token-result').innerHTML =
                '<span class="info">ğŸ”„ OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ ê°ì§€ë¨. "ìƒˆ í† í° ê°€ì ¸ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.</span>';
        }
    });

    // í˜„ì¬ í† í° í™•ì¸
    function checkCurrentToken() {
        const accessToken = localStorage.getItem('accessToken');
        const resultElement = document.getElementById('current-token-result');

        if (accessToken) {
            const tokenPreview = accessToken.substring(0, 15) + '...' + accessToken.substring(accessToken.length - 15);

            // JWT í˜ì´ë¡œë“œ ë””ì½”ë”©
            try {
                const tokenPayload = accessToken.split('.')[1];
                const decodedData = JSON.parse(atob(tokenPayload));
                const issuedAt = new Date(decodedData.iat * 1000);
                const expiresAt = new Date(decodedData.exp * 1000);

                resultElement.innerHTML = `
                    <span class="success">âœ… ì•¡ì„¸ìŠ¤ í† í° ìˆìŒ</span><br>
                    <strong>í† í° ë¯¸ë¦¬ë³´ê¸°:</strong> ${tokenPreview}<br>
                    <strong>ë°œê¸‰ ì‹œê°„:</strong> ${issuedAt.toLocaleString()}<br>
                    <strong>ë§Œë£Œ ì‹œê°„:</strong> ${expiresAt.toLocaleString()}<br>
                    <strong>ì´ë©”ì¼:</strong> ${decodedData.sub}<br>
                    <strong>ì œê³µì:</strong> ${decodedData.provider}
                `;
            } catch (e) {
                resultElement.innerHTML = `<span class="success">âœ… ì•¡ì„¸ìŠ¤ í† í° ìˆìŒ</span><br>í† í°: ${tokenPreview}`;
            }
        } else {
            resultElement.innerHTML = '<span class="error">âŒ localStorageì— ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
        }
    }

    // ìƒˆ í† í° ê°€ì ¸ì˜¤ê¸°
    function fetchNewToken() {
        const resultElement = document.getElementById('current-token-result');
        resultElement.innerHTML = '<span class="info">ğŸ”„ í† í° ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>';

        fetch('/api/v1/auth/token', {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    resultElement.innerHTML = '<span class="success">âœ… ìƒˆ í† í°ì„ ê°€ì ¸ì™€ localStorageì— ì €ì¥í–ˆìŠµë‹ˆë‹¤!</span>';
                    checkCurrentToken();
                } else {
                    resultElement.innerHTML = '<span class="error">âŒ í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</span>';
                }
            })
            .catch(error => {
                resultElement.innerHTML = '<span class="error">âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message + '</span>';
            });
    }

    // í† í° íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    function addToHistory() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('ì €ì¥í•  í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const tokenPayload = accessToken.split('.')[1];
            const decodedData = JSON.parse(atob(tokenPayload));

            const historyItem = {
                timestamp: new Date().toLocaleString(),
                tokenPreview: accessToken.substring(0, 15) + '...' + accessToken.substring(accessToken.length - 15),
                issuedAt: new Date(decodedData.iat * 1000).toLocaleString(),
                email: decodedData.sub,
                provider: decodedData.provider
            };

            tokenHistory.push(historyItem);
            localStorage.setItem('tokenHistory', JSON.stringify(tokenHistory));
            displayTokenHistory();

            alert('í† í°ì´ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (e) {
            alert('í† í° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // í† í° íˆìŠ¤í† ë¦¬ í‘œì‹œ
    function displayTokenHistory() {
        const historyElement = document.getElementById('token-history');

        if (tokenHistory.length === 0) {
            historyElement.innerHTML = '<span class="info">ì•„ì§ ì €ì¥ëœ í† í° íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
            return;
        }

        let historyHtml = '<h4>ğŸ“Š í† í° ë³€ê²½ ë‚´ì—­</h4>';
        tokenHistory.forEach((item, index) => {
            historyHtml += `
                <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                    <strong>${index + 1}ë²ˆì§¸ í† í° (${item.timestamp})</strong><br>
                    í† í°: ${item.tokenPreview}<br>
                    ë°œê¸‰ì‹œê°„: ${item.issuedAt}<br>
                    ì´ë©”ì¼: ${item.email} (${item.provider})
                </div>
            `;
        });

        // í† í° ë³€ê²½ í™•ì¸
        if (tokenHistory.length >= 2) {
            const isChanged = tokenHistory[tokenHistory.length - 1].tokenPreview !== tokenHistory[tokenHistory.length - 2].tokenPreview;
            historyHtml += `<div style="margin-top: 10px; padding: 10px; background-color: ${isChanged ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                <strong>${isChanged ? 'âœ… í† í°ì´ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'âŒ í† í°ì´ ê°±ì‹ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</strong>
            </div>`;
        }

        historyElement.innerHTML = historyHtml;
    }

    // íˆìŠ¤í† ë¦¬ ì‚­ì œ
    function clearHistory() {
        tokenHistory = [];
        localStorage.removeItem('tokenHistory');
        displayTokenHistory();
        alert('í† í° íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // API í…ŒìŠ¤íŠ¸
    function testApi() {
        const resultElement = document.getElementById('api-result');
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            resultElement.innerHTML = '<span class="error">âŒ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
            return;
        }

        resultElement.innerHTML = '<span class="info">ğŸ”„ API í˜¸ì¶œ ì¤‘...</span>';

        fetch('/api/v1/auth/user', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                resultElement.innerHTML = '<span class="success">âœ… API í˜¸ì¶œ ì„±ê³µ:</span><br><pre>' +
                    JSON.stringify(data, null, 2) + '</pre>';
            })
            .catch(error => {
                resultElement.innerHTML = '<span class="error">âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ' + error.message + '</span>';
            });
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        localStorage.removeItem('accessToken');
        document.cookie = 'refreshToken=; Max-Age=0; path=/';
        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        checkCurrentToken();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('check-current-token').addEventListener('click', checkCurrentToken);
    document.getElementById('fetch-new-token').addEventListener('click', fetchNewToken);
    document.getElementById('add-to-history').addEventListener('click', addToHistory);
    document.getElementById('test-api').addEventListener('click', testApi);
</script>
</body>
</html>